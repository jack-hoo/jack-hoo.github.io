<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="文章关键字" />





  <link rel="alternate" href="/atom.xml" title="Jack-Hoo" type="application/atom+xml" />






<meta name="description" content="因为后台需要统计客户端访问的ip以及访问区域，但是项目发布后发现获取到的ip都是127.0.0.1，最后仔 了解了下nginx的配置，解决了这个问题">
<meta name="keywords" content="文章关键字">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx配置代理后获取到的ip都是127.0.0.1解决办法">
<meta property="og:url" content="http://blog.jackhoo.cn/2018/01/25/Nginx配置代理后获取到的ip都是127.0.0.1解决办法/index.html">
<meta property="og:site_name" content="Jack-Hoo">
<meta property="og:description" content="因为后台需要统计客户端访问的ip以及访问区域，但是项目发布后发现获取到的ip都是127.0.0.1，最后仔 了解了下nginx的配置，解决了这个问题">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-03-24T16:28:20.778Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Nginx配置代理后获取到的ip都是127.0.0.1解决办法">
<meta name="twitter:description" content="因为后台需要统计客户端访问的ip以及访问区域，但是项目发布后发现获取到的ip都是127.0.0.1，最后仔 了解了下nginx的配置，解决了这个问题">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.jackhoo.cn/2018/01/25/Nginx配置代理后获取到的ip都是127.0.0.1解决办法/"/>





  <title>Nginx配置代理后获取到的ip都是127.0.0.1解决办法 | Jack-Hoo</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jack-Hoo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Jack's Home</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.jackhoo.cn/2018/01/25/Nginx配置代理后获取到的ip都是127.0.0.1解决办法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JackHoo">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jack-Hoo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Nginx配置代理后获取到的ip都是127.0.0.1解决办法</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-25T00:14:00+08:00">
                2018-01-25
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nginx/" itemprop="url" rel="index">
                    <span itemprop="name">nginx</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
              <div class="post-description">
                  因为后台需要统计客户端访问的ip以及访问区域，但是项目发布后发现获取到的ip都是127.0.0.1，最后仔 了解了下nginx的配置，解决了这个问题
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>squid，varnish以及nginx等，在做反向代理的时候，因为要代替客户端去访问服务器，<br>所以，当请求包经过反向代理后，在代理服务器这里这个IP数据包的IP包头做了修改，<br>最终后端web服务器得到的数据包的头部的源IP地址是代理服务器的IP地址，这样一来，<br>后端服务器的程序给予IP的统计功能就没有任何意义，所以在做代理或集群的时候必须解决这个问题，</p>
<h2 id="办法"><a href="#办法" class="headerlink" title="办法"></a>办法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line"></span><br><span class="line">　　　proxy_pass http:<span class="comment">//127.0.0.1:8083;</span></span><br><span class="line"></span><br><span class="line">　　　proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line"></span><br><span class="line">        proxy_set_header REMOTE-HOST $remote_addr;</span><br><span class="line"></span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="nginx几个变量"><a href="#nginx几个变量" class="headerlink" title="nginx几个变量"></a>nginx几个变量</h2><ol>
<li><p>remote_addr<br>代表客户端的IP，但它的值不是由客户端提供的，而是服务端根据客户端的ip指定的，当你的浏览器访问某个网站时，假设中间没有任何代理，那么网站的web服务器（Nginx，Apache等）就会把remote_addr设为你的机器IP，如果你用了某个代理，那么你的浏览器会先访问这个代理，然后再由这个代理转发到网站，这样web服务器就会把remote_addr设为这台代理机器的IP,除非代理将你的IP附在请求header中一起转交给web服务器。</p>
</li>
<li><p>X-Forwarded-For（简称XFF）</p>
<p> X-Forwarded-For 是一个 HTTP 扩展头部。HTTP/1.1（RFC 2616）协议并没有对它的定义，它最开始是由 Squid 这个缓存代理软件引入，用来表示 HTTP 请求端真实 IP。如今它已经成为事实上的标准，被各大 HTTP 代理、负载均衡等转发服务广泛使用，并被写入 RFC 7239（Forwarded HTTP Extension）标准之中。</p>
<p> XFF的格式为：</p>
<p> X-Forwarded-For: client, proxy1, proxy2<br> XFF 的内容由「英文逗号 + 空格」隔开的多个部分组成，最开始的是离服务端最远的设备 IP，然后是每一级代理设备的 IP。（注意：如果未经严格处理，可以被伪造）</p>
<p> 如果一个 HTTP 请求到达服务器之前，经过了三个代理 Proxy1、Proxy2、Proxy3，IP 分别为 IP1、IP2、IP3，用户真实 IP 为 IP0，那么按照 XFF 标准，服务端最终会收到以下信息：</p>
<p> X-Forwarded-For: IP0, IP1, IP2<br> Proxy3 直连服务器，它会给 XFF 追加 IP2，表示它是在帮 Proxy2 转发请求。列表中并没有 IP3，IP3 可以在服务端通过 Remote Address 字段获得。我们知道 HTTP 连接基于 TCP 连接，HTTP 协议中没有 IP 的概念，Remote Address 来自 TCP 连接，表示与服务端建立 TCP 连接的设备 IP，在这个例子里就是 IP3。Remote Address 无法伪造，因为建立 TCP 连接需要三次握手，如果伪造了源 IP，无法建立 TCP 连接，更不会有后面的 HTTP 请求。但是在正常情况下，web服务器获取Remote Address只会获取到上一级的IP。</p>
</li>
<li><p>X-Real-IP</p>
</li>
</ol>
<p>这又是一个自定义头部字段，通常被 HTTP 代理用来表示与它产生 TCP 连接的设备 IP，这个设备可能是其他代理，也可能是真正的请求端，这个要看经过代理的层级次数或是是否始终将真实IP一路传下来。（注意：如果未经严格处理，可以被伪造）</p>
<h2 id="贴一段根据ip获取区域地址的代码"><a href="#贴一段根据ip获取区域地址的代码" class="headerlink" title="贴一段根据ip获取区域地址的代码"></a>贴一段根据ip获取区域地址的代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.miner.out.jielin_fast.common.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.miner.out.jielin_fast.controller.AuthController;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AddressUtils</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">	 * 请求的参数 格式为：name=xxx&amp;pwd=xxx</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> encoding</span></span><br><span class="line"><span class="comment">	 * 服务器端请求编码。如GBK,UTF-8等</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> UnsupportedEncodingException</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> org.slf4j.Logger log = LoggerFactory.getLogger(AuthController.class);</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getAddresses</span><span class="params">(String ip)</span></span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String urlStr =<span class="string">"http://ip.taobao.com/service/getIpInfo.php"</span>;</span><br><span class="line">			String returnStr = getResult(urlStr, ip);</span><br><span class="line">			<span class="keyword">if</span> (returnStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// 处理返回的省市区信息</span></span><br><span class="line">				String[] temp = returnStr.split(<span class="string">","</span>);</span><br><span class="line">				<span class="keyword">if</span> (temp.length &lt; <span class="number">3</span>) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="string">"0"</span>;<span class="comment">// 无效IP，局域网测试</span></span><br><span class="line">				&#125;</span><br><span class="line">				String region = (temp[<span class="number">5</span>].split(<span class="string">":"</span>))[<span class="number">1</span>].replaceAll(<span class="string">"\""</span>, <span class="string">""</span>);</span><br><span class="line">				region = decodeUnicode(region);<span class="comment">// 省份</span></span><br><span class="line"></span><br><span class="line">				String country = <span class="string">""</span>;</span><br><span class="line">				String area = <span class="string">""</span>;</span><br><span class="line">				<span class="comment">// String region = "";</span></span><br><span class="line">				String city = <span class="string">""</span>;</span><br><span class="line">				String county = <span class="string">""</span>;</span><br><span class="line">				String isp = <span class="string">""</span>;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; temp.length; i++) &#123;</span><br><span class="line">					<span class="keyword">switch</span> (i) &#123;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">							country = (temp[i].split(<span class="string">":"</span>))[<span class="number">2</span>].replaceAll(<span class="string">"\""</span>, <span class="string">""</span>);</span><br><span class="line">							country = decodeUnicode(country);<span class="comment">// 国家</span></span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">							area = (temp[i].split(<span class="string">":"</span>))[<span class="number">1</span>].replaceAll(<span class="string">"\""</span>, <span class="string">""</span>);</span><br><span class="line">							area = decodeUnicode(area);<span class="comment">// 地区</span></span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">							region = (temp[i].split(<span class="string">":"</span>))[<span class="number">1</span>].replaceAll(<span class="string">"\""</span>, <span class="string">""</span>);</span><br><span class="line">							region = decodeUnicode(region);<span class="comment">// 省份</span></span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">							city = (temp[i].split(<span class="string">":"</span>))[<span class="number">1</span>].replaceAll(<span class="string">"\""</span>, <span class="string">""</span>);</span><br><span class="line">							city = decodeUnicode(city);<span class="comment">// 市区</span></span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">							county = (temp[i].split(<span class="string">":"</span>))[<span class="number">1</span>].replaceAll(<span class="string">"\""</span>, <span class="string">""</span>);</span><br><span class="line">							county = decodeUnicode(county);<span class="comment">// 地区</span></span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">							isp = (temp[i].split(<span class="string">":"</span>))[<span class="number">1</span>].replaceAll(<span class="string">"\""</span>, <span class="string">""</span>);</span><br><span class="line">							isp = decodeUnicode(isp); <span class="comment">// ISP公司</span></span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				String address = region+city;</span><br><span class="line">				<span class="keyword">if</span>(StringUtils.isBlank(address))&#123;</span><br><span class="line">					address = <span class="string">"地球村"</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> address;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">"获取ip错误"</span>+e);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> urlStr</span></span><br><span class="line"><span class="comment">	 *            请求的地址</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">	 *            请求的参数 格式为：name=xxx&amp;pwd=xxx</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> encoding</span></span><br><span class="line"><span class="comment">	 *            服务器端请求编码。如GBK,UTF-8等</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getResult</span><span class="params">(String urlStr, String ip)</span> </span>&#123;</span><br><span class="line">		URL url = <span class="keyword">null</span>;</span><br><span class="line">		HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			url = <span class="keyword">new</span> URL(urlStr);</span><br><span class="line">			connection = (HttpURLConnection) url.openConnection();<span class="comment">// 新建连接实例</span></span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * 超时错误 由 2s改为5s</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			connection.setConnectTimeout(<span class="number">5000</span>);<span class="comment">// 设置连接超时时间，单位毫秒</span></span><br><span class="line">			connection.setReadTimeout(<span class="number">5000</span>);<span class="comment">// 设置读取数据超时时间，单位毫秒</span></span><br><span class="line">			connection.setDoOutput(<span class="keyword">true</span>);<span class="comment">// 是否打开输出流 true|false</span></span><br><span class="line">			connection.setDoInput(<span class="keyword">true</span>);<span class="comment">// 是否打开输入流true|false</span></span><br><span class="line">			connection.setRequestMethod(<span class="string">"POST"</span>);<span class="comment">// 提交方法POST|GET</span></span><br><span class="line">			connection.setUseCaches(<span class="keyword">false</span>);<span class="comment">// 是否缓存true|false</span></span><br><span class="line">			connection.connect();<span class="comment">// 打开连接端口</span></span><br><span class="line">			DataOutputStream out = <span class="keyword">new</span> DataOutputStream(connection.getOutputStream());<span class="comment">// 打开输出流往对端服务器写数据</span></span><br><span class="line">			out.writeBytes(<span class="string">"ip="</span>+ip);<span class="comment">// 写数据,也就是提交你的表单 name=xxx&amp;pwd=xxx</span></span><br><span class="line">			out.flush();<span class="comment">// 刷新</span></span><br><span class="line">			out.close();<span class="comment">// 关闭输出流</span></span><br><span class="line">			BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(connection.getInputStream(), <span class="string">"utf-8"</span>));<span class="comment">// 往对端写完数据对端服务器返回数据</span></span><br><span class="line">			<span class="comment">// ,以BufferedReader流来读取</span></span><br><span class="line">			StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">			String line = <span class="string">""</span>;</span><br><span class="line">			<span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">				buffer.append(line);</span><br><span class="line">			&#125;</span><br><span class="line">			reader.close();</span><br><span class="line">			<span class="keyword">return</span> buffer.toString();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">				connection.disconnect();<span class="comment">// 关闭连接</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * unicode 转换成 中文</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> theString</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">decodeUnicode</span><span class="params">(String theString)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">char</span> aChar;</span><br><span class="line">		<span class="keyword">int</span> len = theString.length();</span><br><span class="line">		StringBuffer outBuffer = <span class="keyword">new</span> StringBuffer(len);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; len;) &#123;</span><br><span class="line">			aChar = theString.charAt(x++);</span><br><span class="line">			<span class="keyword">if</span> (aChar == <span class="string">'\\'</span>) &#123;</span><br><span class="line">				aChar = theString.charAt(x++);</span><br><span class="line">				<span class="keyword">if</span> (aChar == <span class="string">'u'</span>) &#123;</span><br><span class="line">					<span class="keyword">int</span> value = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">						aChar = theString.charAt(x++);</span><br><span class="line">						<span class="keyword">switch</span> (aChar) &#123;</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'0'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'1'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'2'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'3'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'4'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'5'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'6'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'7'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'8'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'9'</span>:</span><br><span class="line">							value = (value &lt;&lt; <span class="number">4</span>) + aChar - <span class="string">'0'</span>;</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'a'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'b'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'c'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'d'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'e'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'f'</span>:</span><br><span class="line">							value = (value &lt;&lt; <span class="number">4</span>) + <span class="number">10</span> + aChar - <span class="string">'a'</span>;</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'A'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'B'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'C'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'D'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'E'</span>:</span><br><span class="line">						<span class="keyword">case</span> <span class="string">'F'</span>:</span><br><span class="line">							value = (value &lt;&lt; <span class="number">4</span>) + <span class="number">10</span> + aChar - <span class="string">'A'</span>;</span><br><span class="line">							<span class="keyword">break</span>;</span><br><span class="line">						<span class="keyword">default</span>:</span><br><span class="line">							<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Malformed      encoding."</span>);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					outBuffer.append((<span class="keyword">char</span>) value);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (aChar == <span class="string">'t'</span>) &#123;</span><br><span class="line">						aChar = <span class="string">'\t'</span>;</span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (aChar == <span class="string">'r'</span>) &#123;</span><br><span class="line">						aChar = <span class="string">'\r'</span>;</span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (aChar == <span class="string">'n'</span>) &#123;</span><br><span class="line">						aChar = <span class="string">'\n'</span>;</span><br><span class="line">					&#125; <span class="keyword">else</span> <span class="keyword">if</span> (aChar == <span class="string">'f'</span>) &#123;</span><br><span class="line">						aChar = <span class="string">'\f'</span>;</span><br><span class="line">					&#125;</span><br><span class="line">					outBuffer.append(aChar);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				outBuffer.append(aChar);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> outBuffer.toString();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 获取IP地址</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Author</span>  科帮网</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span>  String</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@Date</span>	2017年7月31日</span></span><br><span class="line"><span class="comment">	 * 更新日志</span></span><br><span class="line"><span class="comment">	 * 2017年7月31日  科帮网 首次创建</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getIpAddr</span><span class="params">(HttpServletRequest request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String ip = request.getHeader(<span class="string">"X-Real-IP"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isBlank(ip) &amp;&amp; !<span class="string">"unknown"</span>.equalsIgnoreCase(ip))</span><br><span class="line">            <span class="keyword">return</span> ip;</span><br><span class="line">        ip = request.getHeader(<span class="string">"X-Forwarded-For"</span>);</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isBlank(ip) &amp;&amp; !<span class="string">"unknown"</span>.equalsIgnoreCase(ip))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> index = ip.indexOf(<span class="string">','</span>);</span><br><span class="line">            <span class="keyword">if</span>(index != -<span class="number">1</span>)</span><br><span class="line">               <span class="keyword">return</span> ip.substring(<span class="number">0</span>, index);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> ip;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip))</span><br><span class="line">            ip = request.getHeader(<span class="string">"Proxy-Client-IP"</span>);</span><br><span class="line">        <span class="keyword">if</span>(ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip))</span><br><span class="line">            ip = request.getHeader(<span class="string">"WL-Proxy-Client-IP"</span>);</span><br><span class="line">        <span class="keyword">if</span>(ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip))</span><br><span class="line">            ip = request.getHeader(<span class="string">"HTTP_CLIENT_IP"</span>);</span><br><span class="line">        <span class="keyword">if</span>(ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip))</span><br><span class="line">            ip = request.getHeader(<span class="string">"HTTP_X_FORWARDED_FOR"</span>);</span><br><span class="line">        <span class="keyword">if</span>(ip == <span class="keyword">null</span> || ip.length() == <span class="number">0</span> || <span class="string">"unknown"</span>.equalsIgnoreCase(ip))</span><br><span class="line">            ip = request.getRemoteAddr();</span><br><span class="line">        <span class="keyword">return</span> ip;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/nginx/" rel="tag"># nginx</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/11/06/Java常用String类小记/" rel="next" title="Java常用String类小记">
                <i class="fa fa-chevron-left"></i> Java常用String类小记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/29/ArrayList在for循环中使用remove方法移除元素带来的问题/" rel="prev" title="ArrayList在for循环中使用remove方法移除元素带来的问题">
                ArrayList在for循环中使用remove方法移除元素带来的问题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="JackHoo" />
            
              <p class="site-author-name" itemprop="name">JackHoo</p>
              <p class="site-description motion-element" itemprop="description">A blog of Jack-Hoo</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">27</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">38</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jack-hoo" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="979783618@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#原因"><span class="nav-number">1.</span> <span class="nav-text">原因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#办法"><span class="nav-number">2.</span> <span class="nav-text">办法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx几个变量"><span class="nav-number">3.</span> <span class="nav-text">nginx几个变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#贴一段根据ip获取区域地址的代码"><span class="nav-number">4.</span> <span class="nav-text">贴一段根据ip获取区域地址的代码</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JackHoo</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
